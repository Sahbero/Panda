<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sosisli Platform Atlayışı</title>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            font-family: 'Comic Sans MS', 'Comic Sans', cursive;
            color: #333;
            overflow: hidden;
            user-select: none;
        }
        #gameContainer {
            position: relative;
            width: 480px;
            height: 640px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
        }
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
        }
        #fireworksCanvas {
            z-index: 15;
            pointer-events: none;
        }
        #gameCanvas {
            z-index: 10;
        }
        #characterSelectScreen, #countdownScreen, #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            /* Varsayılan olarak gizli */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 20;
            text-align: center;
        }
        #characterSelectScreen h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: #555;
        }
        #characterList {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .character-card {
            width: 120px;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 3px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .character-card.selected {
            border-color: #FF69B4;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .character-card h3 {
            margin-top: 10px;
            font-size: 1.2rem;
        }
        #startButton, #restartButton {
            padding: 15px 30px;
            font-size: 1.5rem;
            background-color: #FF69B4;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        #startButton:hover, #restartButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        #countdownScreen p {
            font-size: 5rem;
            color: #FF69B4;
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        #game-info {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 25;
            display: none;
            /* Varsayılan olarak gizli */
            gap: 15px;
            align-items: center;
        }
        #lives-container {
            display: flex;
            gap: 5px;
        }
        .heart-svg {
            width: 30px;
            height: 30px;
        }
        #celebrationMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 2.5rem;
            color: #FF69B4;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5); /* Okunurluk için gölge eklendi */
            z-index: 30;
            display: none;
            opacity: 0;
            animation: bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.27) forwards,
                       fadeOut 0.5s 1.5s forwards;
        }
        #gameOverScreen p {
            font-size: 3rem;
            color: #d32f2f;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #final-score {
            font-size: 2rem;
            color: #555;
            margin-bottom: 30px;
        }
        #controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            width: 480px;
        }
        /* Hide controls on larger screens */
        @media (min-width: 769px) {
            #controls {
                display: none;
            }
        }
        .control-button {
            width: 80px;
            height: 80px;
            font-size: 2rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .control-button:active {
            transform: scale(0.95);
        }
        .control-button.left, .control-button.right {
            background-color: #2196F3;
        }
        .control-button.up {
            background-color: #FFC107;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes bounceIn {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            60% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="480" height="640"></canvas>
        <canvas id="fireworksCanvas" width="480" height="640"></canvas>
        <div id="game-info">
            <span id="score-display">Puan: 0</span>
            <div id="lives-container"></div>
        </div>
        
        <div id="characterSelectScreen">
            <h1>Karakterini Seç</h1>
            <div id="characterList">
                <div class="character-card" data-character="panda">
                    <svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.ears{fill:#2b2b2b;}.face{fill:#ffffff;}.eyes{fill:#2b2b2b;}.nose{fill:#2b2b2b;}</style><circle class="ears" cx="25" cy="25" r="20"/><circle class="ears" cx="75" cy="25" r="20"/><circle class="face" cx="50" cy="50" r="40"/><circle class="eyes" cx="35" cy="45" r="8"/><circle class="eyes" cx="65" cy="45" r="8"/><path class="nose" d="M50 58 C45 62, 55 62, 50 58 M45 60 Q50 65, 55 60 T50 60"/></svg>
                    <h3>Panda</h3>
                </div>
                <div class="character-card" data-character="rabbit">
                    <img src="tavsan.png" alt="Tavşan" width="80" height="80" id="rabbit-image" onerror="this.onerror=null;this.src='https://placehold.co/80x80/FFC0CB/000?text=Tavsan';">
                    <h3>Tavşan</h3>
                </div>
                <div class="character-card" data-character="dragon">
                    <svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.head{fill:#48c774;}.eyes{fill:yellow;}.horns{fill:#805a41;}.mouth{fill:#805a41;}</style><path class="head" d="M20 60 Q50 20, 80 60 L60 80 Q50 90, 40 80 Z"/><path class="horns" d="M30 40 L25 15 L35 25 Z"/><path class="horns" d="M70 40 L75 15 L65 25 Z"/><circle class="eyes" cx="40" cy="55" r="5"/><circle class="eyes" cx="60" cy="55" r="5"/><path class="mouth" d="M40 70 C45 75, 55 75, 60 70" fill="none" stroke="red" stroke-width="2"/></svg>
                    <h3>Ejderha</h3>
                </div>
                <div class="character-card" data-character="koala">
                    <svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.ears{fill:#7a7a7a;}.face{fill:#c2c2c2;}.eyes{fill:#333;}.nose{fill:#333;}</style><circle class="ears" cx="20" cy="20" r="20"/><circle class="ears" cx="80" cy="20" r="20"/><path class="face" d="M50 40 C20 40, 20 80, 50 80 C80 80, 80 40, 50 40 Z"/><circle class="eyes" cx="38" cy="50" r="6"/><circle class="eyes" cx="62" cy="50" r="6"/><path class="nose" d="M50 65 C45 68, 55 68, 50 65"/></svg>
                    <h3>Koala</h3>
                </div>
                <div class="character-card" data-character="kelek">
                    <img src="kelek.png" alt="Kelek" width="80" height="80" onerror="this.onerror=null;this.src='https://placehold.co/80x80/FF6347/FFF?text=Kelek';">
                    <h3>Kelek</h3>
                </div>
                <div class="character-card" data-character="zirzop">
                    <img src="zırzop.png" alt="Zırzop" width="80" height="80" onerror="this.onerror=null;this.src='https://placehold.co/80x80/9370DB/FFF?text=Zırzop';">
                    <h3>Zırzop</h3>
                </div>
            </div>
            <button id="startButton" style="display: none;">Oyuna Başla</button>
        </div>

        <div id="countdownScreen">
            <p id="countdownDisplay"></p>
        </div>

        <div id="celebrationMessage"></div>

        <div id="gameOverScreen">
            <p>Oyun Bitti!</p>
            <p id="final-score"></p>
            <button id="restartButton">Tekrar Dene</button>
        </div>
    </div>
    
    <div id="controls">
        <button id="leftButton" class="control-button left">◀</button>
        <button id="jumpButton" class="control-button up">▲</button>
        <button id="rightButton" class="control-button right">▶</button>
    </div>

    <script>
        // --- Oyun Sabitleri ve DOM Elemanları ---
        const gameCanvas = document.getElementById('gameCanvas');
        const fireworksCanvas = document.getElementById('fireworksCanvas');
        const ctx = gameCanvas.getContext('2d');
        const fxCtx = fireworksCanvas.getContext('2d');
        const GAME_WIDTH = gameCanvas.width;
        const GAME_HEIGHT = gameCanvas.height;
        const scoreDisplay = document.getElementById('score-display');
        const livesContainer = document.getElementById('lives-container');
        const gameInfo = document.getElementById('game-info');
        const characterSelectScreen = document.getElementById('characterSelectScreen');
        const characterCards = document.querySelectorAll('.character-card');
        const startButton = document.getElementById('startButton');
        const countdownScreen = document.getElementById('countdownScreen');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const celebrationMessage = document.getElementById('celebrationMessage');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartButton = document.getElementById('restartButton');
        const leftButton = document.getElementById('leftButton');
        const jumpButton = document.getElementById('jumpButton');
        const rightButton = document.getElementById('rightButton');
        // Yaratıcı tebrik mesajları
        const CELEBRATION_MESSAGES = [
            "İnanılmazsın! Devam et!",
            "Harikasın! Yenilmezsin!",
            "Efsane bir skor!",
            "Tebrikler! Adeta uçuyorsun!",
            "Mükemmel bir başarı!",
        ];
        // --- Görsel Veriler (SVG ve Resim URL'leri) ---
        const SAUSAGE_SVG = `<svg viewBox="0 0 200 40" xmlns="http://www.w3.org/2000/svg">
            <style> .bun{fill:#d2b48c;} .sausage{fill:#ff694f;} .mustard{fill:#ffc107;} </style>
            <rect class="bun" x="0" y="0" width="200" height="40" rx="15" ry="15"/>
            <path class="bun" d="M0 20 C50 5, 150 5, 200 20 L200 35 Q150 45, 100 35 Q50 45, 0 35 Z"/>
            <rect class="sausage" x="10" y="10" width="180" height="20" rx="10" ry="10"/>
            <path class="mustard" d="M20 20 Q50 10, 100 20 T180 20" stroke-width="3" stroke-linecap="round" fill="none" stroke="#ffc107"/>
        </svg>`;
        const CLOUD_SVG = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M10 50 A20 20 0 0 1 30 30 A25 25 0 0 1 70 30 A20 20 0 0 1 90 50 A15 15 0 0 1 75 60 L25 60 A15 15 0 0 1 10 50 Z" fill="white" fill-opacity="0.7"/></svg>`;
        const HEART_SVG = `<svg class="heart-svg" viewBox="0 0 24 24" fill="red" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
        const DRAGON_SVG = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.head{fill:#48c774;}.eyes{fill:yellow;}.horns{fill:#805a41;}.mouth{fill:#805a41;}</style><path class="head" d="M20 60 Q50 20, 80 60 L60 80 Q50 90, 40 80 Z"/><path class="horns" d="M30 40 L25 15 L35 25 Z"/><path class="horns" d="M70 40 L75 15 L65 25 Z"/><circle class="eyes" cx="40" cy="55" r="5"/><circle class="eyes" cx="60" cy="55" r="5"/><path class="mouth" d="M40 70 C45 75, 55 75, 60 70" fill="none" stroke="red" stroke-width="2"/></svg>`;
        const MUSHROOM_SVG = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.stem{fill:#fff}.cap{fill:#c00}.dots{fill:#fff}</style><rect class="stem" x="40" y="55" width="20" height="40"/><path class="cap" d="M20 55 C20 20, 80 20, 80 55 Z"/><circle class="dots" cx="35" cy="40" r="5"/><circle class="dots" cx="65" cy="40" r="5"/><circle class="dots" cx="50" cy="30" r="5"/></svg>`;
        const CHARACTERS = {
            panda: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.ears{fill:#2b2b2b;}.face{fill:#ffffff;}.eyes{fill:#2b2b2b;}.nose{fill:#2b2b2b;}</style><circle class="ears" cx="25" cy="25" r="20"/><circle class="ears" cx="75" cy="25" r="20"/><circle class="face" cx="50" cy="50" r="40"/><circle class="eyes" cx="35" cy="45" r="8"/><circle class="eyes" cx="65" cy="45" r="8"/><path class="nose" d="M50 58 C45 62, 55 62, 50 58 M45 60 Q50 65, 55 60 T50 60"/></svg>`,
            rabbit: 'tavsan.png',
            dragon: DRAGON_SVG,
            koala: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.ears{fill:#7a7a7a;}.face{fill:#c2c2c2;}.eyes{fill:#333;}.nose{fill:#333;}</style><circle class="ears" cx="20" cy="20" r="20"/><circle class="ears" cx="80" cy="20" r="20"/><path class="face" d="M50 40 C20 40, 20 80, 50 80 C80 80, 80 40, 50 40 Z"/><circle class="eyes" cx="38" cy="50" r="6"/><circle class="eyes" cx="62" cy="50" r="6"/><path class="nose" d="M50 65 C45 68, 55 68, 50 65"/></svg>`,
            kelek: 'kelek.png',
            zirzop: 'zırzop.png'
        };
        // --- Oyun Durum Yönetimi ---
        let gameState = 'SELECT_CHARACTER';
        // --- Oyun Değişkenleri ---
        let character = {
            x: 0,
            y: 0,
            width: 40,
            height: 40,
            velocityX: 0,
            velocityY: 0,
            gravity: 0.5,
            jumpStrength: -12,
            isJumping: false,
            image: null,
            baseSpeed: 3
        };
        let platforms = [];
        let clouds = [];
        let dragons = [];
        let fireballs = [];
        let balloons = [];
        let mushrooms = [];
        let fireworks = [];
        let score = 0;
        let lives = 3;
        let lastCelebrationScore = 0;
        let lastDragonSpawnScore = 0;
        let lastBalloonsSpawnScore = 0;
        let lastMushroomSpawnScore = 0;
        let nextMushroomSpawnScore = 0;
        // İlk değer oyun başlangıcında atanacak
        let isSpeedBoostActive = false;
        let flashEffectActive = false;
        let flashColorIndex = 0;
        const flashColors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff'];
        let touchMoveDirection = 0;
        // 0: yok, 1: sağ, -1: sol

        // --- Ses Değişkenleri ---
        let deathSound;
        let mushroomSound;
        let dragonSound;
        let backgroundMusic; // Arka plan müziği için yeni değişken

        // --- Ses Dosyalarını Yükleme Fonksiyonu ---
        function loadSounds() {
            // Karakter öldüğünde çalacak ses
            deathSound = new Audio();
            deathSound.src = 'ölüm.m4a'; 

            // Mantar alındığında çalacak ses
            mushroomSound = new Audio();
            mushroomSound.src = 'mantar.m4a';

            // Ejderha çıktığında çalacak ses
            dragonSound = new Audio();
            dragonSound.src = 'ejderha.m4a';
            
            // --- Arka plan müziği ---
            backgroundMusic = new Audio();
            backgroundMusic.loop = true; // Müziğin sürekli tekrar etmesi için
            // Bu alana arka plan müziği dosyasının GitHub "Raw" (Ham) URL'sini ekleyin
            backgroundMusic.src = 'sound.mp3';
        }

        // --- Bulut Oluşturma Fonksiyonu ---
        function createClouds() {
            clouds = [];
            for (let i = 0; i < 5; i++) {
                clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: Math.random() * GAME_HEIGHT * 0.8,
                    width: Math.random() * 80 + 100,
                    height: Math.random() * 40 + 40
                });
            }
        }

        // --- Platform Oluşturma Fonksiyonu ---
        function createPlatforms() {
            platforms = [];
            const initialPlatform = { x: GAME_WIDTH / 2 - 50, y: GAME_HEIGHT - 50, width: 100, height: 20 };
            platforms.push(initialPlatform);
            character.x = initialPlatform.x + (initialPlatform.width / 2) - (character.width / 2);
            character.y = initialPlatform.y - character.height;
            for (let i = 0; i < 15; i++) {
                const lastPlatform = platforms[platforms.length - 1];
                const newY = lastPlatform.y - Math.floor(Math.random() * (140 - 90 + 1) + 90);
                const maxHorizontalJumpDistance = 200;
                const minX = Math.max(0, lastPlatform.x - maxHorizontalJumpDistance);
                const maxX = Math.min(GAME_WIDTH - 80, lastPlatform.x + maxHorizontalJumpDistance);
                const newX = Math.random() * (maxX - minX) + minX;

                platforms.push({ x: newX, y: newY, width: 80, height: 20 });
            }
        }
        
        // --- Ejderha ve Balonları Oluşturma Fonksiyonları ---
        function spawnDragon() {
            const dragonWidth = 120;
            const dragonHeight = 80;
            const spawnSide = Math.random() > 0.5 ? 'left' : 'right';
            const dragon = {
                x: spawnSide === 'left' ? -dragonWidth + 40 : GAME_WIDTH - 40,
                y: GAME_HEIGHT,
                width: dragonWidth,
                height: dragonHeight,
                image: new Image(),
                spawnTime: Date.now(),
                fireDirection: spawnSide === 'left' ? 1 : -1,
                velocityY: -0.8,
                fireSpawnTimer: Date.now(),
                // Ejderhanın ateş topu püskürtme sıklığı iki katına çıkarıldı (gecikme yarıya indi)
                fireballSpawnDelay: Math.random() * 1000 + 750 
            };
            dragon.image.src = 'data:image/svg+xml;base64,' + btoa(DRAGON_SVG);
            dragons.push(dragon);
            lastDragonSpawnScore = score;

            // Ejderha ortaya çıktığında ses çal
            if (dragonSound) {
                dragonSound.currentTime = 0;
                dragonSound.play();
            }
        }

        function spawnFireball(dragon) {
            const fireRadius = 10 + Math.random() * 5;
            const fireX = dragon.x + (dragon.fireDirection === 1 ? dragon.width - 20 : 20);
            const fireY = dragon.y + dragon.height / 2;
            const fireball = {
                x: fireX,
                y: fireY,
                radius: fireRadius,
                velocityX: dragon.fireDirection * (Math.random() * 1 + 0.5), // Ateş topu hızı düşürüldü
                velocityY: -(Math.random() * 1 + 0.5), // Ateş topu hızı düşürüldü
                creationTime: Date.now()
            };
            fireballs.push(fireball);
        }
        
        function spawnBalloons() {
            const balloonColors = ['#FF69B4', '#FFD700', '#00BFFF', '#ADFF2F', '#FF4500'];
            for (let i = 0; i < 10; i++) {
                const balloon = {
                    x: Math.random() * GAME_WIDTH,
                    y: GAME_HEIGHT + Math.random() * 100,
                    radius: Math.random() * 10 + 15,
                    color: balloonColors[Math.floor(Math.random() * balloonColors.length)],
                    velocityX: (Math.random() - 0.5) * 0.5,
                    // Balonların hızı 2 katına çıkarıldı.
                    velocityY: -2 * (Math.random() * 0.5 + 1), 
                };
                balloons.push(balloon);
            }
            lastBalloonsSpawnScore = score;
        }

        function spawnMushroom() {
            const mushroomWidth = 40;
            const mushroomHeight = 40;
            const mushroom = {
                x: Math.random() * (GAME_WIDTH - mushroomWidth),
                y: GAME_HEIGHT + 20,
                width: mushroomWidth,
                height: mushroomHeight,
                velocityY: -1.2 // Hız 1.5 kat artırıldı (-0.8 * 1.5)
            };
            mushrooms.push(mushroom);
            lastMushroomSpawnScore = score;
            nextMushroomSpawnScore = score + Math.floor(Math.random() * 11) + 30; // Yeni mantar için puan aralığı
        }
        
        // Havai fişek oluşturma fonksiyonu
        function createFireworks() {
            const centerX = GAME_WIDTH / 2;
            const centerY = GAME_HEIGHT / 2;
            const particleCount = 50;
            const colors = ['#ff0040', '#ff8000', '#ffff00', '#00ff80', '#0040ff', '#8000ff'];
            for (let i = 0; i < particleCount; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 5 + 2;
                fireworks.push({
                    x: centerX,
                    y: centerY,
                    size: Math.random() * 2 + 1,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    velocityX: Math.cos(angle) * speed,
                    velocityY: Math.sin(angle) * speed,
                    alpha: 1
                });
            }
        }
        
        // --- Çizim Fonksiyonları ---
        function drawCharacter() {
            if (character.image && character.image.complete) {
                ctx.drawImage(character.image, character.x, character.y, character.width, character.height);
            } else {
                ctx.fillStyle = '#663399';
                ctx.fillRect(character.x, character.y, character.width, character.height);
            }
        }
        
        function drawSausagePlatform(platform) {
            const sausageImg = new Image();
            sausageImg.src = 'data:image/svg+xml;base64,' + btoa(SAUSAGE_SVG);
            ctx.drawImage(sausageImg, platform.x, platform.y, platform.width, platform.height);
        }

        function drawPlatforms() {
            platforms.forEach(platform => {
                drawSausagePlatform(platform);
            });
        }

        function drawClouds() {
            const cloudImg = new Image();
            cloudImg.src = 'data:image/svg+xml;base64,' + btoa(CLOUD_SVG);
            clouds.forEach(cloud => {
                ctx.drawImage(cloudImg, cloud.x, cloud.y, cloud.width, cloud.height);
            });
        }
        
        function drawDragon(dragon) {
            if (dragon.image.complete) {
                if (dragon.fireDirection === -1) {
                    ctx.save();
                    ctx.scale(-1, 1);
                    ctx.drawImage(dragon.image, -dragon.x - dragon.width, dragon.y, dragon.width, dragon.height);
                    ctx.restore();
                } else {
                    ctx.drawImage(dragon.image, dragon.x, dragon.y, dragon.width, dragon.height);
                }
            }
        }

        function drawFireballs() {
            fireballs.forEach(fireball => {
                ctx.fillStyle = `rgba(255, ${Math.floor(Math.random() * 150)}, 0, 0.8)`;
                ctx.beginPath();
                ctx.arc(fireball.x, fireball.y, fireball.radius, 0, Math.PI * 2);
                ctx.fill();
            });
        }
        
        function drawBalloons() {
            balloons.forEach(balloon => {
                ctx.fillStyle = balloon.color;
                ctx.beginPath();
                ctx.ellipse(balloon.x, balloon.y, balloon.radius, balloon.radius * 1.3, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = balloon.color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(balloon.x, balloon.y + balloon.radius * 1.3);
                ctx.lineTo(balloon.x, balloon.y + balloon.radius * 2.5);
                ctx.stroke();
            });
        }

        function drawMushroom() {
            const mushroomImg = new Image();
            mushroomImg.src = 'data:image/svg+xml;base64,' + btoa(MUSHROOM_SVG);
            mushrooms.forEach(mushroom => {
                ctx.drawImage(mushroomImg, mushroom.x, mushroom.y, mushroom.width, mushroom.height);
            });
        }

        function drawFireworks() {
            fxCtx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            fireworks.forEach(particle => {
                fxCtx.fillStyle = particle.color;
                fxCtx.globalAlpha = particle.alpha;
                fxCtx.beginPath();
                fxCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
                fxCtx.fill();
            });
            fxCtx.globalAlpha = 1;
        }

        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, GAME_HEIGHT, 0, 0);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#1E90FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            drawClouds();
        }

        function drawScore() {
            scoreDisplay.innerText = `Puan: ${score}`;
        }
        
        function drawLives() {
            livesContainer.innerHTML = '';
            for (let i = 0; i < lives; i++) {
                const heart = document.createElement('div');
                heart.innerHTML = HEART_SVG;
                livesContainer.appendChild(heart);
            }
        }

        function showCelebrationMessage() {
            const randomMessage = CELEBRATION_MESSAGES[Math.floor(Math.random() * CELEBRATION_MESSAGES.length)];
            celebrationMessage.innerText = randomMessage;
            celebrationMessage.style.display = 'block';
            celebrationMessage.style.opacity = '1';
            celebrationMessage.style.animation = 'bounceIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.27) forwards, fadeOut 0.5s 1.5s forwards';
            createFireworks();
            
            setTimeout(() => {
                celebrationMessage.style.display = 'none';
                celebrationMessage.style.animation = '';
            }, 2000);
        }

        function activatePowerUp() {
            isSpeedBoostActive = true;
            flashEffectActive = true;
            
            setTimeout(() => {
                isSpeedBoostActive = false;
            }, 5000);
            let flashInterval = setInterval(() => {
                flashColorIndex = (flashColorIndex + 1) % flashColors.length;
            }, 100);
            setTimeout(() => {
                flashEffectActive = false;
                clearInterval(flashInterval);
            }, 5000);
        }
        
        function showGameOverScreen() {
            gameState = 'GAME_OVER';
            gameInfo.style.display = 'none';
            gameOverScreen.style.display = 'flex';
            finalScoreDisplay.innerText = `Son Puanınız: ${score}`;
            // Oyun bittiğinde müziği durdur
            if (backgroundMusic) {
                backgroundMusic.pause();
            }
        }
        
        function loseLife() {
            // Can kaybettikçe ses çal
            if (deathSound) {
                deathSound.currentTime = 0;
                deathSound.play();
            }

            lives--;
            drawLives();
            if (lives <= 0) {
                showGameOverScreen();
            } else {
                const lowestPlatform = platforms.reduce((min, p) => (p.y > min.y ? p : min), platforms[0]);
                character.x = lowestPlatform.x + (lowestPlatform.width / 2) - (character.width / 2);
                character.y = lowestPlatform.y - character.height;
                character.velocityY = 0;
                character.velocityX = 0;
            }
        }
        
        // --- Oyun Mantığı Güncelleme ---
        function update() {
            // Hız güçlendirmesi aktifse hızı ikiye katla
            const moveSpeed = isSpeedBoostActive ? character.baseSpeed * 2 : character.baseSpeed;
            
            // --- Karakter ve Platform Güncelleme ---
            character.x += character.velocityX * moveSpeed;
            // Mobil kontroller için
            if (touchMoveDirection !== 0) {
                character.x += touchMoveDirection * moveSpeed;
            }

            character.velocityY += character.gravity;
            character.y += character.velocityY;
            if (character.x < 0) character.x = 0;
            if (character.x + character.width > GAME_WIDTH) character.x = GAME_WIDTH - character.width;
            platforms.forEach(platform => {
                if (character.velocityY > 0 &&
                    character.y + character.height >= platform.y &&
                    character.y + character.height <= platform.y + platform.height &&
                    character.x + character.width > platform.x &&
                    character.x < platform.x + platform.width) {
                    
                    if (character.isJumping) {
                        // Puanlama mantığı kaldırıldı, artık platform kaydırıldığında puan kazanılacak
                    }
                    
                    character.velocityY = 0;
                    character.y = platform.y - character.height;
                    character.isJumping = false;
                }
            });
            if (character.y < GAME_HEIGHT / 4) {
                const scrollSpeed = GAME_HEIGHT / 4 - character.y;
                character.y += scrollSpeed;
                
                platforms.forEach(platform => {
                    platform.y += scrollSpeed;
                });
                clouds.forEach(cloud => {
                    cloud.y += scrollSpeed * 0.5;
                });
                balloons.forEach(balloon => {
                    balloon.y += scrollSpeed;
                });
                mushrooms.forEach(mushroom => {
                    mushroom.y += scrollSpeed;
                });
            }
            
            if (platforms.length > 0 && platforms[0].y > GAME_HEIGHT) {
                platforms.shift();
                // Puanlama mantığı buraya taşındı: her yeni platform geldiğinde puan artacak
                score += 1;
                if (score > 0 && score % 20 === 0 && score !== lastCelebrationScore) {
                    showCelebrationMessage();
                    lastCelebrationScore = score;
                }
                const lastPlatform = platforms[platforms.length - 1];
                const newY = lastPlatform.y - Math.floor(Math.random() * (140 - 90 + 1) + 90);
                const maxHorizontalJumpDistance = 200;
                const minX = Math.max(0, lastPlatform.x - maxHorizontalJumpDistance);
                const maxX = Math.min(GAME_WIDTH - 80, lastPlatform.x + maxHorizontalJumpDistance);
                const newX = Math.random() * (maxX - minX) + minX;

                platforms.push({ x: newX, y: newY, width: 80, height: 20 });
            }
            
            if (clouds.length > 0 && clouds[0].y > GAME_HEIGHT) {
                clouds.shift();
                clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: -100,
                    width: Math.random() * 80 + 100,
                    height: Math.random() * 40 + 40
                });
            }

            if (character.y > GAME_HEIGHT) {
                loseLife();
            }

            // --- Ejderha Güncelleme ---
            if (score > 0 && score % 30 === 0 && score !== lastDragonSpawnScore) {
                spawnDragon();
            }
            
            for (let i = dragons.length - 1; i >= 0; i--) {
                const dragon = dragons[i];
                const elapsedTime = Date.now() - dragon.spawnTime;

                if (elapsedTime > 5000 || dragon.y < -dragon.height) {
                    dragons.splice(i, 1);
                    continue;
                }
                
                dragon.y += dragon.velocityY;
                if (Date.now() - dragon.fireSpawnTimer > dragon.fireballSpawnDelay) {
                     spawnFireball(dragon);
                     dragon.fireSpawnTimer = Date.now();
                     // Ejderhanın ateş topu püskürtme sıklığı iki katına çıkarıldı (gecikme yarıya indi)
                     dragon.fireballSpawnDelay = Math.random() * 1000 + 750;
                }
            }

            // --- Ateş Topu Güncelleme ve Çarpışma Kontrolü ---
            for (let i = fireballs.length - 1; i >= 0; i--) {
                const fireball = fireballs[i];
                fireball.x += fireball.velocityX;
                fireball.y += fireball.velocityY;
                
                if (fireball.y < -fireball.radius || fireball.x < -fireball.radius || fireball.x > GAME_WIDTH + fireball.radius) {
                    fireballs.splice(i, 1);
                    continue;
                }
                
                const dist = Math.hypot((character.x + character.width/2) - fireball.x, (character.y + character.height/2) - fireball.y);
                if (dist < character.width/2 + fireball.radius) {
                    loseLife();
                    fireballs.splice(i, 1);
                }
            }

            // --- Balon Güncelleme (Hata Düzeltildi) ---
            if (score > 0 && score % 50 === 0 && score !== lastBalloonsSpawnScore) {
                spawnBalloons();
                lastBalloonsSpawnScore = score; // Bu satır eklenerek hatanın tekrarlanması engellendi.
            }
            
            for (let i = balloons.length - 1; i >= 0; i--) {
                const balloon = balloons[i];
                balloon.y += balloon.velocityY;
                balloon.x += balloon.velocityX;
                
                if (balloon.y < -balloon.radius * 2) {
                    balloons.splice(i, 1);
                }
            }
            
            // --- Mantar Güncelleme ---
            if (score >= nextMushroomSpawnScore && score > lastMushroomSpawnScore) {
                spawnMushroom();
            }

            for (let i = mushrooms.length - 1; i >= 0; i--) {
                const mushroom = mushrooms[i];
                mushroom.y += mushroom.velocityY;
                
                if (character.x < mushroom.x + mushroom.width &&
                    character.x + character.width > mushroom.x &&
                    character.y < mushroom.y + mushroom.height &&
                    character.y + character.height > mushroom.y) {
                    
                    activatePowerUp();
                    mushrooms.splice(i, 1);

                    // Mantar alındığında ses çal
                    if (mushroomSound) {
                        mushroomSound.currentTime = 0;
                        mushroomSound.play();
                    }
                }
                
                if (mushroom.y < -mushroom.height) {
                    mushrooms.splice(i, 1);
                }
            }

            // Havai fişek güncellemesi
            for (let i = fireworks.length - 1; i >= 0; i--) {
                const p = fireworks[i];
                p.x += p.velocityX;
                p.y += p.velocityY;
                p.alpha -= 0.01;
                p.velocityY += 0.05;
                if (p.alpha <= 0) {
                    fireworks.splice(i, 1);
                }
            }
        }
        
        // --- Oyun Döngüsü ---
        function gameLoop() {
            if (gameState !== 'PLAYING') {
                return;
            }
            
            drawBackground();
            update();
            
            drawBalloons();
            drawMushroom();
            drawPlatforms();
            dragons.forEach(dragon => drawDragon(dragon));
            drawFireballs();
            drawCharacter();
            drawScore();
            drawLives();
            drawFireworks();
            if (flashEffectActive) {
                ctx.fillStyle = flashColors[flashColorIndex];
                ctx.globalAlpha = 0.3;
                ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
                ctx.globalAlpha = 1;
            }

            requestAnimationFrame(gameLoop);
        }
        
        // --- Karakter görselini yükleyen fonksiyon ---
        function setCharacterImage(charKey) {
            const charData = CHARACTERS[charKey];
            character.image = new Image();

            if (charKey === 'panda' || charKey === 'dragon' || charKey === 'koala') {
                 character.image.src = 'data:image/svg+xml;base64,' + btoa(charData);
            } else {
                character.image.src = charData;
            }
            
            character.image.onload = () => {
                // Görsel yüklendiğinde geri sayımı başlat
                startCountdown();
            };
            character.image.onerror = () => {
                console.error(`Görsel yüklenemedi: ${charData}`);
                // Hata durumunda bile devam et
                startCountdown();
            };
        }

        function initGame() {
            score = 0;
            lives = 3;
            gameState = 'SELECT_CHARACTER';
            character.velocityX = 0;
            character.velocityY = 0;
            lastDragonSpawnScore = 0;
            lastBalloonsSpawnScore = 0;
            lastCelebrationScore = 0;
            lastMushroomSpawnScore = 0;
            nextMushroomSpawnScore = Math.floor(Math.random() * 11) + 30;
            isSpeedBoostActive = false;
            flashEffectActive = false;
            dragons = [];
            fireballs = [];
            balloons = [];
            mushrooms = [];
            fireworks = [];
            // Sesleri yükle
            loadSounds();
            
            createPlatforms();
            createClouds();
            // Tüm ekranları gizle, sadece karakter seçimi göster
            hideAllScreens();
            characterSelectScreen.style.display = 'flex';
        }

        function hideAllScreens() {
            characterSelectScreen.style.display = 'none';
            countdownScreen.style.display = 'none';
            gameOverScreen.style.display = 'none';
            gameInfo.style.display = 'none';
        }

        // --- Kontrol Olay Dinleyicileri ---
        const handleLeft = () => { if (gameState === 'PLAYING') character.velocityX = -1; };
        const handleRight = () => { if (gameState === 'PLAYING') character.velocityX = 1; };
        const handleStop = () => { if (gameState === 'PLAYING') character.velocityX = 0; };
        const handleJump = () => {
            if (gameState === 'PLAYING' && !character.isJumping) {
                character.velocityY = character.jumpStrength;
                character.isJumping = true;
            }
        };
        // Mobil tuşlar
        leftButton.addEventListener('mousedown', () => { touchMoveDirection = -1; });
        leftButton.addEventListener('mouseup', () => { touchMoveDirection = 0; });
        leftButton.addEventListener('mouseleave', () => { touchMoveDirection = 0; });
        leftButton.addEventListener('touchstart', (e) => { e.preventDefault(); touchMoveDirection = -1; }, { passive: false });
        leftButton.addEventListener('touchend', () => { touchMoveDirection = 0; });

        rightButton.addEventListener('mousedown', () => { touchMoveDirection = 1; });
        rightButton.addEventListener('mouseup', () => { touchMoveDirection = 0; });
        rightButton.addEventListener('mouseleave', () => { touchMoveDirection = 0; });
        rightButton.addEventListener('touchstart', (e) => { e.preventDefault(); touchMoveDirection = 1; }, { passive: false });
        rightButton.addEventListener('touchend', () => { touchMoveDirection = 0; });
        
        jumpButton.addEventListener('click', handleJump);
        jumpButton.addEventListener('touchstart', (e) => { e.preventDefault(); handleJump(); }, { passive: false });
        // Klavye tuşları
        document.addEventListener('keydown', (e) => {
            if (gameState !== 'PLAYING') return;
            switch (e.code) {
                case 'ArrowLeft':
                    character.velocityX = -1;
                    break;
                case 'ArrowRight':
                    character.velocityX = 1;
                    break;
                case 'ArrowUp':
                case 'Space':
                    handleJump();
                    break;
            }
        });
        document.addEventListener('keyup', (e) => {
            if (gameState !== 'PLAYING') return;
            switch (e.code) {
                case 'ArrowLeft':
                case 'ArrowRight':
                    character.velocityX = 0;
                    break;
            }
        });
        // --- Karakter Seçim ve Oyun Başlatma Mantığı ---
        let selectedCharacter = null;
        characterCards.forEach(card => {
            card.addEventListener('click', () => {
                characterCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedCharacter = card.dataset.character;
                startButton.style.display = 'block';
            });
        });
        
        function startCountdown() {
            hideAllScreens();
            countdownScreen.style.display = 'flex';
            let count = 3;
            countdownDisplay.innerText = count;
            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownDisplay.innerText = count;
                } else {
                    clearInterval(countdownInterval);
                    gameState = 'PLAYING';
                    hideAllScreens();
                    gameInfo.style.display = 'flex';
                    drawLives();
                    drawScore();
                    // Oyun müziğini başlat
                    if (backgroundMusic) {
                        backgroundMusic.play();
                    }
                    gameLoop();
                }
            }, 1000);
        }

        startButton.addEventListener('click', () => {
            if (selectedCharacter) {
                // Oyunu sıfırla, sonra karakteri yükle ve geri sayımı başlat
                initGame();
                setCharacterImage(selectedCharacter);
            }
        });
        
        restartButton.addEventListener('click', () => {
            initGame();
        });
        // Oyun başlatılmadan önce ilk ekranı göster
        initGame();
    </script>
</body>
</html>
