<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sosisli Platform Atlayışı</title>
    <style>
        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            font-family: 'Comic Sans MS', 'Comic Sans', cursive;
            color: #333;
            overflow: hidden;
            user-select: none;
        }
        #gameContainer {
            position: relative;
            width: 480px;
            height: 640px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            overflow: hidden;
        }
        canvas {
            display: block;
        }
        #characterSelectScreen, #countdownScreen, #gameOverScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 10;
            text-align: center;
        }
        #characterSelectScreen h1 {
            font-size: 2.5rem;
            margin-bottom: 30px;
            color: #555;
        }
        #characterList {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .character-card {
            width: 120px;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 3px solid transparent;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .character-card.selected {
            border-color: #FF69B4;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .character-card h3 {
            margin-top: 10px;
            font-size: 1.2rem;
        }
        #startButton, #restartButton {
            padding: 15px 30px;
            font-size: 1.5rem;
            background-color: #FF69B4;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        #startButton:hover, #restartButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        #countdownScreen p {
            font-size: 5rem;
            color: #FF69B4;
            font-weight: bold;
            animation: pulse 1s infinite;
        }
        #game-info {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 5;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        #lives-container {
            display: flex;
            gap: 5px;
        }
        .heart-svg {
            width: 30px;
            height: 30px;
        }
        #celebrationMessage {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 2rem;
            color: #FF69B4;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            z-index: 20;
            display: none;
            animation: fadeinout 2s forwards;
        }
        #gameOverScreen p {
            font-size: 3rem;
            color: #d32f2f;
            font-weight: bold;
            margin-bottom: 20px;
        }
        #final-score {
            font-size: 2rem;
            color: #555;
            margin-bottom: 30px;
        }
        #controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
            width: 480px;
        }
        /* Hide controls on larger screens */
        @media (min-width: 769px) {
            #controls {
                display: none;
            }
        }
        .control-button {
            width: 80px;
            height: 80px;
            font-size: 2rem;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s ease, transform 0.1s ease;
        }
        .control-button:active {
            transform: scale(0.95);
        }
        .control-button.left, .control-button.right {
            background-color: #2196F3;
        }
        .control-button.up {
            background-color: #FFC107;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes fadeinout {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="480" height="640"></canvas>
        <div id="game-info">
            <span id="score-display">Puan: 0</span>
            <div id="lives-container"></div>
        </div>
        
        <!-- Karakter Seçim Ekranı -->
        <div id="characterSelectScreen">
            <h1>Karakterini Seç</h1>
            <div id="characterList">
                <div class="character-card" data-character="panda">
                    <!-- Panda SVG'si -->
                    <svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.ears{fill:#2b2b2b;}.face{fill:#ffffff;}.eyes{fill:#2b2b2b;}.nose{fill:#2b2b2b;}</style><circle class="ears" cx="25" cy="25" r="20"/><circle class="ears" cx="75" cy="25" r="20"/><circle class="face" cx="50" cy="50" r="40"/><circle class="eyes" cx="35" cy="45" r="8"/><circle class="eyes" cx="65" cy="45" r="8"/><path class="nose" d="M50 58 C45 62, 55 62, 50 58 M45 60 Q50 65, 55 60 T50 60"/></svg>
                    <h3>Panda</h3>
                </div>
                <div class="character-card" data-character="rabbit">
                    <!-- Tavşan görseli artık SVG yerine bir resim URL'si ile yükleniyor. -->
                    <img src="tavsan.png" alt="Tavşan" width="80" height="80" id="rabbit-image">
                    <h3>Tavşan</h3>
                </div>
                <div class="character-card" data-character="dragon">
                    <!-- Ejderha SVG'si -->
                    <svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.head{fill:#48c774;}.eyes{fill:yellow;}.horns{fill:#805a41;}</style><path class="head" d="M20 60 Q50 30, 80 60 L60 80 Q50 90, 40 80 Z"/><path class="horns" d="M30 40 L25 15 L35 25 Z"/><path class="horns" d="M70 40 L75 15 L65 25 Z"/><circle class="eyes" cx="40" cy="55" r="5"/><circle class="eyes" cx="60" cy="55" r="5"/><path class="mouth" d="M40 70 C45 75, 55 75, 60 70" fill="none" stroke="red" stroke-width="2"/></svg>
                    <h3>Ejderha</h3>
                </div>
                <div class="character-card" data-character="koala">
                    <!-- Koala SVG'si -->
                    <svg width="80" height="80" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.ears{fill:#7a7a7a;}.face{fill:#c2c2c2;}.eyes{fill:#333;}.nose{fill:#333;}</style><circle class="ears" cx="20" cy="20" r="20"/><circle class="ears" cx="80" cy="20" r="20"/><path class="face" d="M50 40 C20 40, 20 80, 50 80 C80 80, 80 40, 50 40 Z"/><circle class="eyes" cx="38" cy="50" r="6"/><circle class="eyes" cx="62" cy="50" r="6"/><path class="nose" d="M50 65 C45 68, 55 68, 50 65"/></svg>
                    <h3>Koala</h3>
                </div>
            </div>
            <button id="startButton" style="display: none;">Oyuna Başla</button>
        </div>

        <!-- Geri Sayım Ekranı -->
        <div id="countdownScreen" style="display: none;">
            <p id="countdownDisplay"></p>
        </div>

        <!-- Kutlama Mesajı -->
        <div id="celebrationMessage">Tebrikler!</div>

        <!-- Oyun Bitti Ekranı -->
        <div id="gameOverScreen" style="display: none;">
            <p>Oyun Bitti!</p>
            <p id="final-score"></p>
            <button id="restartButton">Tekrar Dene</button>
        </div>
    </div>
    
    <!-- Mobil Kontrol Tuşları -->
    <div id="controls">
        <button id="leftButton" class="control-button left">◀</button>
        <button id="jumpButton" class="control-button up">▲</button>
        <button id="rightButton" class="control-button right">▶</button>
    </div>

    <script>
        // --- Oyun Sabitleri ve DOM Elemanları ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const GAME_WIDTH = canvas.width;
        const GAME_HEIGHT = canvas.height;
        const scoreDisplay = document.getElementById('score-display');
        const livesContainer = document.getElementById('lives-container');
        const characterSelectScreen = document.getElementById('characterSelectScreen');
        const characterCards = document.querySelectorAll('.character-card');
        const startButton = document.getElementById('startButton');
        const countdownScreen = document.getElementById('countdownScreen');
        const countdownDisplay = document.getElementById('countdownDisplay');
        const celebrationMessage = document.getElementById('celebrationMessage');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreDisplay = document.getElementById('final-score');
        const restartButton = document.getElementById('restartButton');
        const leftButton = document.getElementById('leftButton');
        const jumpButton = document.getElementById('jumpButton');
        const rightButton = document.getElementById('rightButton');

        // --- Görsel Veriler (SVG ve Resim URL'leri) ---
        const SAUSAGE_SVG = `<svg viewBox="0 0 100 20" xmlns="http://www.w3.org/2000/svg"><rect x="0" y="0" width="100" height="20" rx="10" ry="10" fill="#ff694f"/><path d="M5 10 C20 5, 80 5, 95 10 Q80 15, 20 15 Z" fill="#e55347"/></svg>`;
        const CLOUD_SVG = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M10 50 A20 20 0 0 1 30 30 A25 25 0 0 1 70 30 A20 20 0 0 1 90 50 A15 15 0 0 1 75 60 L25 60 A15 15 0 0 1 10 50 Z" fill="white" fill-opacity="0.7"/></svg>`;
        const HEART_SVG = `<svg class="heart-svg" viewBox="0 0 24 24" fill="red" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
        const DRAGON_SVG = `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.head{fill:#48c774;}.eyes{fill:yellow;}.horns{fill:#805a41;}</style><path class="head" d="M20 60 Q50 30, 80 60 L60 80 Q50 90, 40 80 Z"/><path class="horns" d="M30 40 L25 15 L35 25 Z"/><path class="horns" d="M70 40 L75 15 L65 25 Z"/><circle class="eyes" cx="40" cy="55" r="5"/><circle class="eyes" cx="60" cy="55" r="5"/><path class="mouth" d="M40 70 C45 75, 55 75, 60 70" fill="none" stroke="red" stroke-width="2"/></svg>`;

        const CHARACTERS = {
            panda: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.ears{fill:#2b2b2b;}.face{fill:#ffffff;}.eyes{fill:#2b2b2b;}.nose{fill:#2b2b2b;}</style><circle class="ears" cx="25" cy="25" r="20"/><circle class="ears" cx="75" cy="25" r="20"/><circle class="face" cx="50" cy="50" r="40"/><circle class="eyes" cx="35" cy="45" r="8"/><circle class="eyes" cx="65" cy="45" r="8"/><path class="nose" d="M50 58 C45 62, 55 62, 50 58 M45 60 Q50 65, 55 60 T50 60"/></svg>`,
            rabbit: 'tavsan.png', // Kullanıcının istediği güncel URL
            dragon: DRAGON_SVG,
            koala: `<svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><style>.ears{fill:#7a7a7a;}.face{fill:#c2c2c2;}.eyes{fill:#333;}.nose{fill:#333;}</style><circle class="ears" cx="20" cy="20" r="20"/><circle class="ears" cx="80" cy="20" r="20"/><path class="face" d="M50 40 C20 40, 20 80, 50 80 C80 80, 80 40, 50 40 Z"/><circle class="eyes" cx="38" cy="50" r="6"/><circle class="eyes" cx="62" cy="50" r="6"/><path class="nose" d="M50 65 C45 68, 55 68, 50 65"/></svg>`
        };

        // --- Oyun Değişkenleri ---
        let character = {
            x: 0,
            y: 0,
            width: 40,
            height: 40,
            velocityX: 0,
            velocityY: 0,
            gravity: 0.5,
            jumpStrength: -12,
            isJumping: false,
            image: null // Karakter görseli için Image objesi
        };

        let platforms = [];
        let clouds = [];
        let dragons = []; // Ejderha nesnelerini saklamak için dizi
        let balloons = []; // Balon nesnelerini saklamak için dizi
        let score = 0;
        let lives = 3;
        let lastCelebrationScore = 0;
        let isGameActive = false;
        let lastDragonSpawnScore = 0;
        let hasBalloonsSpawned = false;

        // --- Bulut Oluşturma Fonksiyonu ---
        function createClouds() {
            clouds = [];
            for (let i = 0; i < 5; i++) {
                clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: Math.random() * GAME_HEIGHT * 0.8,
                    width: Math.random() * 80 + 100,
                    height: Math.random() * 40 + 40
                });
            }
        }

        // --- Platform Oluşturma Fonksiyonu ---
        function createPlatforms() {
            platforms = [];
            const initialPlatform = { x: GAME_WIDTH / 2 - 50, y: GAME_HEIGHT - 50, width: 100, height: 20 };
            platforms.push(initialPlatform);

            character.x = initialPlatform.x + (initialPlatform.width / 2) - (character.width / 2);
            character.y = initialPlatform.y - character.height;

            for (let i = 0; i < 15; i++) {
                const lastPlatform = platforms[platforms.length - 1];
                const newY = lastPlatform.y - Math.floor(Math.random() * (140 - 90 + 1) + 90);
                const maxHorizontalJumpDistance = 200;
                const minX = Math.max(0, lastPlatform.x - maxHorizontalJumpDistance);
                const maxX = Math.min(GAME_WIDTH - 80, lastPlatform.x + maxHorizontalJumpDistance);
                const newX = Math.random() * (maxX - minX) + minX;

                platforms.push({ x: newX, y: newY, width: 80, height: 20 });
            }
        }
        
        // --- Ejderha ve Balonları Oluşturma Fonksiyonları ---
        function spawnDragon() {
            const dragonWidth = 80;
            const dragonHeight = 80;
            const dragon = {
                x: Math.random() * (GAME_WIDTH - dragonWidth),
                y: GAME_HEIGHT,
                width: dragonWidth,
                height: dragonHeight,
                image: new Image(),
                spawnTime: Date.now(),
                fire: []
            };
            dragon.image.src = 'data:image/svg+xml;base64,' + btoa(DRAGON_SVG);
            dragons.push(dragon);
            lastDragonSpawnScore = score;
        }
        
        function spawnBalloons() {
            const balloonColors = ['#FF69B4', '#FFD700', '#00BFFF', '#ADFF2F', '#FF4500'];
            for (let i = 0; i < 10; i++) {
                const balloon = {
                    x: Math.random() * GAME_WIDTH,
                    y: GAME_HEIGHT + Math.random() * 100,
                    radius: Math.random() * 10 + 15,
                    color: balloonColors[Math.floor(Math.random() * balloonColors.length)],
                    velocityX: (Math.random() - 0.5) * 0.5,
                    velocityY: -1 * (Math.random() * 0.5 + 1),
                };
                balloons.push(balloon);
            }
            hasBalloonsSpawned = true;
        }

        // --- Çizim Fonksiyonları ---
        function drawCharacter() {
            if (character.image && character.image.complete) {
                ctx.drawImage(character.image, character.x, character.y, character.width, character.height);
            } else {
                ctx.fillStyle = '#663399';
                ctx.fillRect(character.x, character.y, character.width, character.height);
            }
        }
        
        function drawSausagePlatform(platform) {
            const sausageImg = new Image();
            sausageImg.src = 'data:image/svg+xml;base64,' + btoa(SAUSAGE_SVG);
            ctx.drawImage(sausageImg, platform.x, platform.y, platform.width, platform.height);
        }

        function drawPlatforms() {
            platforms.forEach(platform => {
                drawSausagePlatform(platform);
            });
        }

        function drawClouds() {
            const cloudImg = new Image();
            cloudImg.src = 'data:image/svg+xml;base64,' + btoa(CLOUD_SVG);
            clouds.forEach(cloud => {
                ctx.drawImage(cloudImg, cloud.x, cloud.y, cloud.width, cloud.height);
            });
        }
        
        function drawDragon(dragon) {
            if (dragon.image.complete) {
                ctx.drawImage(dragon.image, dragon.x, dragon.y, dragon.width, dragon.height);
            }
            // Ateş nefesi
            const fireRadius = 10 + Math.random() * 5;
            const fireX = dragon.x + dragon.width / 2;
            const fireY = dragon.y - fireRadius;
            
            ctx.fillStyle = `rgba(255, ${Math.floor(Math.random() * 150)}, 0, 0.8)`;
            ctx.beginPath();
            ctx.arc(fireX, fireY, fireRadius, 0, Math.PI * 2);
            ctx.fill();
            
            // Ateşin yavaşça yukarı süzülmesi için
            const fireBall = {
                x: fireX,
                y: fireY,
                radius: fireRadius,
                speed: 1.5,
                creationTime: Date.now()
            };
            dragon.fire.push(fireBall);
        }
        
        function drawBalloons() {
            balloons.forEach(balloon => {
                ctx.fillStyle = balloon.color;
                ctx.beginPath();
                ctx.ellipse(balloon.x, balloon.y, balloon.radius, balloon.radius * 1.3, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = balloon.color;
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(balloon.x, balloon.y + balloon.radius * 1.3);
                ctx.lineTo(balloon.x, balloon.y + balloon.radius * 2.5);
                ctx.stroke();
            });
        }

        function drawBackground() {
            const gradient = ctx.createLinearGradient(0, GAME_HEIGHT, 0, 0);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#1E90FF');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
            drawClouds();
        }

        function drawScore() {
            scoreDisplay.innerText = `Puan: ${score}`;
        }
        
        function drawLives() {
            livesContainer.innerHTML = '';
            for (let i = 0; i < lives; i++) {
                const heart = document.createElement('div');
                heart.innerHTML = HEART_SVG;
                livesContainer.appendChild(heart);
            }
        }

        function showCelebrationMessage() {
            celebrationMessage.style.display = 'block';
            setTimeout(() => {
                celebrationMessage.style.display = 'none';
            }, 2000);
        }
        
        function showGameOverScreen() {
            isGameActive = false;
            gameOverScreen.style.display = 'flex';
            finalScoreDisplay.innerText = `Son Puanınız: ${score}`;
        }
        
        function loseLife() {
            lives--;
            drawLives();
            if (lives <= 0) {
                showGameOverScreen();
            } else {
                const lowestPlatform = platforms.reduce((min, p) => (p.y > min.y ? p : min), platforms[0]);
                character.x = lowestPlatform.x + (lowestPlatform.width / 2) - (character.width / 2);
                character.y = lowestPlatform.y - character.height;
                character.velocityY = 0;
                character.velocityX = 0;
            }
        }
        
        // --- Oyun Mantığı Güncelleme ---
        function update() {
            if (!isGameActive) {
                return;
            }
            
            // --- Karakter ve Platform Güncelleme ---
            character.x += character.velocityX;
            character.velocityY += character.gravity;
            character.y += character.velocityY;

            if (character.x < 0) character.x = 0;
            if (character.x + character.width > GAME_WIDTH) character.x = GAME_WIDTH - character.width;

            platforms.forEach(platform => {
                if (character.velocityY > 0 &&
                    character.y + character.height >= platform.y &&
                    character.y + character.height <= platform.y + platform.height &&
                    character.x + character.width > platform.x &&
                    character.x < platform.x + platform.width) {
                    
                    if (character.isJumping) {
                        score += 1;
                        if (score > 0 && score % 20 === 0 && score !== lastCelebrationScore) {
                            showCelebrationMessage();
                            lastCelebrationScore = score;
                        }
                    }
                    
                    character.velocityY = 0;
                    character.y = platform.y - character.height;
                    character.isJumping = false;
                }
            });

            if (character.y < GAME_HEIGHT / 4) {
                const scrollSpeed = GAME_HEIGHT / 4 - character.y;
                character.y += scrollSpeed;
                
                platforms.forEach(platform => {
                    platform.y += scrollSpeed;
                });
                clouds.forEach(cloud => {
                    cloud.y += scrollSpeed * 0.5;
                });
            }
            
            if (platforms.length > 0 && platforms[0].y > GAME_HEIGHT) {
                platforms.shift();
                const lastPlatform = platforms[platforms.length - 1];
                const newY = lastPlatform.y - Math.floor(Math.random() * (140 - 90 + 1) + 90);
                const maxHorizontalJumpDistance = 200;
                const minX = Math.max(0, lastPlatform.x - maxHorizontalJumpDistance);
                const maxX = Math.min(GAME_WIDTH - 80, lastPlatform.x + maxHorizontalJumpDistance);
                const newX = Math.random() * (maxX - minX) + minX;

                platforms.push({ x: newX, y: newY, width: 80, height: 20 });
            }
            
            if (clouds.length > 0 && clouds[0].y > GAME_HEIGHT) {
                clouds.shift();
                clouds.push({
                    x: Math.random() * GAME_WIDTH,
                    y: -100,
                    width: Math.random() * 80 + 100,
                    height: Math.random() * 40 + 40
                });
            }

            if (character.y > GAME_HEIGHT) {
                loseLife();
            }

            // --- Ejderha Güncelleme ---
            if (score > 0 && score % 30 === 0 && score !== lastDragonSpawnScore) {
                spawnDragon();
            }
            
            for (let i = dragons.length - 1; i >= 0; i--) {
                const dragon = dragons[i];
                const elapsedTime = Date.now() - dragon.spawnTime;

                if (elapsedTime > 5000 || dragon.y < -dragon.height) {
                    dragons.splice(i, 1);
                    continue;
                }
                
                dragon.y -= 1.5; // Ejderhanın yukarı çıkış hızı
                
                // Karakter ve ejderha/ateş çarpışma kontrolü
                if (character.x < dragon.x + dragon.width &&
                    character.x + character.width > dragon.x &&
                    character.y < dragon.y + dragon.height &&
                    character.y + character.height > dragon.y) {
                    
                    loseLife();
                    dragons.splice(i, 1);
                    continue;
                }
                
                // Ateş topu güncelleme ve çizimi
                for (let j = dragon.fire.length - 1; j >= 0; j--) {
                    const fireBall = dragon.fire[j];
                    fireBall.y -= fireBall.speed;
                    fireBall.radius *= 0.98;
                    
                    if (fireBall.radius < 1 || fireBall.y < 0) {
                        dragon.fire.splice(j, 1);
                        continue;
                    }

                    ctx.fillStyle = `rgba(255, ${Math.floor(Math.random() * 150)}, 0, 0.8)`;
                    ctx.beginPath();
                    ctx.arc(fireBall.x, fireBall.y, fireBall.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Karakter ve ateş topu çarpışma kontrolü
                    const dist = Math.hypot((character.x + character.width/2) - fireBall.x, (character.y + character.height/2) - fireBall.y);
                    if (dist < character.width/2 + fireBall.radius) {
                        loseLife();
                        dragons.splice(i, 1); // Ejderha yok oluyor
                        break;
                    }
                }
            }

            // --- Balon Güncelleme ---
            if (score >= 50 && !hasBalloonsSpawned) {
                spawnBalloons();
            }
            
            for (let i = balloons.length - 1; i >= 0; i--) {
                const balloon = balloons[i];
                balloon.y += balloon.velocityY;
                balloon.x += balloon.velocityX;
                
                if (balloon.y < -balloon.radius * 2) {
                    balloons.splice(i, 1);
                }
            }
        }
        
        // --- Oyun Döngüsü ---
        function gameLoop() {
            if (!isGameActive) {
                return;
            }
            drawBackground();
            
            update();
            
            drawBalloons();
            drawPlatforms();
            dragons.forEach(dragon => drawDragon(dragon));
            drawCharacter();
            drawScore();
            drawLives();
            
            requestAnimationFrame(gameLoop);
        }
        
        // --- Karakter görselini yükleyen fonksiyon ---
        function setCharacterImage(charKey) {
            const charData = CHARACTERS[charKey];
            character.image = new Image();

            if (charKey === 'rabbit') {
                 character.image.src = charData;
            } else {
                character.image.src = 'data:image/svg+xml;base64,' + btoa(charData);
            }
            
            character.image.onload = () => {
                drawCharacter();
            };
            character.image.onerror = () => {
                console.error(`Görsel yüklenemedi: ${charData}`);
            };
        }

        function initGame() {
            score = 0;
            lives = 3;
            isGameActive = false;
            character.velocityX = 0;
            character.velocityY = 0;
            lastDragonSpawnScore = 0;
            hasBalloonsSpawned = false;
            dragons = [];
            balloons = [];
            
            createPlatforms();
            createClouds();
            drawLives();
            drawScore();
            drawBackground();
            drawPlatforms();
            drawCharacter();
        }

        // --- Kontrol Olay Dinleyicileri ---
        const handleLeft = () => { if (isGameActive) character.velocityX = -3; };
        const handleRight = () => { if (isGameActive) character.velocityX = 3; };
        const handleStop = () => { if (isGameActive) character.velocityX = 0; };
        const handleJump = () => {
            if (isGameActive && !character.isJumping) {
                character.velocityY = character.jumpStrength;
                character.isJumping = true;
            }
        };

        leftButton.addEventListener('mousedown', handleLeft);
        leftButton.addEventListener('mouseup', handleStop);
        leftButton.addEventListener('mouseleave', handleStop);
        leftButton.addEventListener('touchstart', handleLeft, { passive: false });
        leftButton.addEventListener('touchend', handleStop);

        rightButton.addEventListener('mousedown', handleRight);
        rightButton.addEventListener('mouseup', handleStop);
        rightButton.addEventListener('mouseleave', handleStop);
        rightButton.addEventListener('touchstart', handleRight, { passive: false });
        rightButton.addEventListener('touchend', handleStop);

        jumpButton.addEventListener('click', handleJump);
        jumpButton.addEventListener('touchend', handleJump);
        
        document.addEventListener('keydown', (e) => {
            if (!isGameActive) return;
            switch (e.code) {
                case 'ArrowLeft':
                    character.velocityX = -3;
                    break;
                case 'ArrowRight':
                    character.velocityX = 3;
                    break;
                case 'ArrowUp':
                case 'Space':
                    handleJump();
                    break;
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!isGameActive) return;
            switch (e.code) {
                case 'ArrowLeft':
                case 'ArrowRight':
                    character.velocityX = 0;
                    break;
            }
        });

        // --- Karakter Seçim ve Oyun Başlatma Mantığı ---
        let selectedCharacter = null;
        characterCards.forEach(card => {
            card.addEventListener('click', () => {
                characterCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selectedCharacter = card.dataset.character;
                startButton.style.display = 'block';

                setCharacterImage(selectedCharacter);
            });
        });
        
        function startCountdown() {
            characterSelectScreen.style.display = 'none';
            countdownScreen.style.display = 'flex';
            let count = 3;
            countdownDisplay.innerText = count;

            const countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownDisplay.innerText = count;
                } else {
                    clearInterval(countdownInterval);
                    countdownScreen.style.display = 'none';
                    isGameActive = true;
                    gameLoop();
                }
            }, 1000);
        }

        startButton.addEventListener('click', () => {
            if (selectedCharacter) {
                initGame();
                startCountdown();
            }
        });
        
        restartButton.addEventListener('click', () => {
                gameOverScreen.style.display = 'none';
                characterSelectScreen.style.display = 'flex';
                startButton.style.display = 'none';
                characterCards.forEach(c => c.classList.remove('selected'));
                initGame(); // Oyunu tamamen sıfırla
        });
        
        // Oyun başlatılmadan önce ilk çizimi yap
        initGame();
    </script>
</body>
</html>
